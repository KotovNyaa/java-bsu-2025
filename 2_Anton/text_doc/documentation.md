# Техническая документация

Этот документ описывает архитектуру и компоненты каждого модуля системы.

## Общая архитектура и поток данных

1.  **Прием команды:** `UI` или внешний клиент отправляет запрос в `API` модуль.
2.  **CQRS и Outbox:** `ApiTransactionService` (Command-часть) не выполняет операцию, а создает `TransactionCommand` и сохраняет ее в таблицу `transaction_outbox`. Клиент получает мгновенный ответ.
3.  **Асинхронная выборка:** `OutboxPoller` из `Application` модуля периодически запрашивает новые команды из `transaction_outbox`.
4.  **Конвейер обработки:** `OutboxPoller` публикует команды в `RingBuffer` (LMAX Disruptor), расположенный в `Core-Engine`.
5.  **Обработка в памяти:** Команда проходит по цепочке обработчиков:
    a. `IdempotencyCheckConsumer`: Проверка на дубликат.
    b. `BusinessLogicConsumer`: Выполнение бизнес-логики (изменение баланса) над состоянием, хранящимся в памяти (`AccountState`).
    c. `JournalingConsumer`: Запись в журнал упреждающей записи (WAL).
    d. `BatchDatabasePersistenceConsumer`: Агрегация всех изменений.
6.  **Атомарное сохранение:** Когда батч в Disruptor завершен, `BatchDatabasePersistenceConsumer` вызывает `JdbcBatchPersister` из `Persistence` модуля.
7.  **Транзакция в БД:** `JdbcBatchPersister` в одной транзакции: обновляет балансы счетов, удаляет запись из `transaction_outbox`, сохраняет ключ идемпотентности и пишет в аудит-журнал.
8.  **Уведомление:** Фоновый процесс в `API` замечает, что транзакция обработана (по таблице `processed_transactions`) и уведомляет `UI` через паттерн Observer.
9.  **Чтение данных:** Если клиенту нужно получить состояние, он обращается к `QueryService` (`API`), который напрямую читает данные из таблиц БД.

---

## Модуль: `domain`

-   **Назначение:** Ядро бизнес-логики. Определяет "что" система делает, но не "как".
-   **Компоненты:**
    -   `Account`: "Богатая" доменная модель. Инкапсулирует данные (баланс, статус) и поведение (deposit, withdraw, freeze). Защищает свои бизнес-правила (инварианты).
    -   `User`: Простой POJO для хранения данных о пользователе и ссылок на `UUID` его счетов.
    -   `AccountStatus`: `Enum`, определяющий жизненный цикл счета.

---

## Модуль: `core-engine`

-   **Назначение:** Высокопроизводительное ядро обработки транзакций.
-   **Компоненты:**
    -   `TransactionRingBuffer`: Настраивает и запускает конвейер LMAX Disruptor.
    -   `TransactionCommand`: Неизменяемый объект-команда.
    -   `TransactionEvent`: Мутабельный "конверт" для передачи команды по `RingBuffer`.
    -   `Consumers` (`BusinessLogicConsumer`, etc.): Шаги конвейера, каждый отвечает за свой этап обработки.
    -   `Actions` (`DepositAction`, etc.): Реализации паттерна Стратегия для конкретных бизнес-операций.
    -   `Ports` (`port/out`): Интерфейсы (`BatchPersister`, `JournalingService`), определяющие контракт для взаимодействия с внешними системами (например, БД).

---

## Модуль: `persistence`

-   **Назначение:** Адаптер для взаимодействия с реляционной базой данных.
-   **Компоненты:**
    -   `JdbcBatchPersister`: Ключевой класс. Реализует порт `BatchPersister`. Атомарно сохраняет пакет изменений (`BatchUnitOfWork`) в рамках одной транзакции БД. Реализует логику Transactional Outbox и Dead-Letter Queue (DLQ).
    -   `JdbcAccountRepository`: Реализует репозиторий для загрузки счетов.
    -   `JdbcJournalRepository`: Реализует сервис для ведения аудиторского журнала.
    -   `AccountMapper`: Утилита для преобразования `ResultSet` в доменный объект `Account`.
    -   `DataAccessException`: Кастомное runtime-исключение для абстрагирования от `SQLException`.

---

## Модуль: `application`

-   **Назначение:** Модуль-оркестратор, который собирает и запускает все части системы.
-   **Компоненты:**
    -   `BankApplication`: Главный класс, управляющий жизненным циклом. Инициализирует Disruptor, восстанавливает состояние из БД, запускает поллер.
    -   `TransactionService`: Публичный API. Реализация `TransactionServiceImpl` сохраняет команды в `outbox`.
    -   `OutboxPoller`: Фоновый процесс, который читает `transaction_outbox` и публикует команды в Disruptor. Использует `SELECT ... FOR UPDATE SKIP LOCKED` для масштабируемости.
    -   `IdempotencyCheckConsumer`: Потребитель Disruptor, отвечающий за проверку на дубликаты.

---

## Модуль: `api`

-   **Назначение:** Высокоуровневый фасад для внешних клиентов.
-   **Компоненты:**
    -   `BankServerFacade`: Центральный класс-фасад. Инициализирует БД, запускает `BankApplication`, предоставляет единый API и управляет системой уведомлений (Observer).
    -   `ApiTransactionService`: Реализует Command-часть CQRS. Отвечает за постановку команд в `transaction_outbox`.
    -   `AdminService`: Для административных задач (создание пользователей/счетов).
    -   `QueryService`: Реализует Query-часть CQRS. Отвечает за чтение данных из БД для отчетов.

---

## Модуль: `ui`

-   **Назначение:** Предоставляет пользовательские интерфейсы.
-   **Компоненты:**
    -   `ServerConnection` (интерфейс): Контракт, отделяющий UI от реализации бэкенда.
    -   `DirectAdapter` (реализация `ServerConnection`): Адаптер, который напрямую вызывает `BankServerFacade`. Реализует симуляцию сетевых проблем (блокировка и буферизация команд).
    -   **CLI (`cli` пакет):**
        -   `ConsoleRunner`: Запускает и управляет консольным интерфейсом. (ненадежно, было для тестов, сейчас это мертвый код чтобы не изменять особо сессион контест потому что я ленивый)
        -   `SessionContext`: Хранит состояние сессии (текущий пользователь/счет).
    -   **GUI (`javafx` пакет):**
        -   `FxBankApp`: Точка входа в JavaFX-приложение.
        -   `MainController`: "Мозг" GUI, обрабатывает действия пользователя (архитектура MVC).
        -   `ViewBuilder`: "Руки" GUI, отвечает за создание и отрисовку компонентов.
