# Используемые паттерны проектирования

Этот документ описывает ключевые паттерны, примененные в проекте, и их роль в архитектуре.

## Архитектурные паттерны

### Ports & Adapters (Hexagonal Architecture)
-   **Описание:** Изолирует ядро бизнес-логики от внешних зависимостей (UI, БД, сервисы).
-   **Реализация:**
    -   **Ядро (`core-engine`, `domain`):** Содержит бизнес-логику и определяет "порты" (интерфейсы, например, `BatchPersister`, `AccountRepository`).
    -   **Адаптеры:**
        -   `persistence`: "Исходящий" адаптер, реализующий порты для работы с JDBC.
        -   `api`: "Входящий" адаптер, предоставляющий API для взаимодействия с ядром.
        -   `ui`: Еще один "входящий" адаптер для взаимодействия с пользователем.

### Command Query Responsibility Segregation (CQRS)
-   **Описание:** Разделение операций на "Команды" (изменяющие состояние) и "Запросы" (читающие состояние).
-   **Реализация:**
    -   **Команды:** Обрабатываются через `ApiTransactionService` и `AdminService`. Они принимают запрос, ставят его в очередь (`outbox`) и возвращают быстрый ответ.
    -   **Запросы:** Обрабатываются через `QueryService`, который напрямую читает данные из БД и возвращает готовые DTO для отображения.

### Transactional Outbox
-   **Описание:** Паттерн для надежной асинхронной коммуникации. Изменения состояния и события сохраняются в одной транзакции в БД. Отдельный процесс читает "outbox" и доставляет события.
-   **Реализация:** `ApiTransactionService` пишет команды в `transaction_outbox`. `OutboxPoller` (`application`) читает их. `JdbcBatchPersister` (`persistence`) атомарно обновляет счета и удаляет запись из `outbox`.

### LMAX Disruptor
-   **Описание:** Архитектурный паттерн для высокопроизводительной межпотоковой передачи данных с низкой задержкой, основанный на кольцевом буфере.
-   **Реализация:** `TransactionRingBuffer` в `core-engine` организует конвейер из `EventHandler` (потребителей) для последовательной обработки транзакций в памяти.

## Поведенческие паттерны

### Strategy
-   **Описание:** Определяет семейство алгоритмов, инкапсулирует каждый из них и делает их взаимозаменяемыми.
-   **Реализация:** Интерфейсы `SingleAccountAction`, `TransferAction` определяют стратегии. Классы `DepositAction`, `WithdrawAction` и т.д. — конкретные реализации. `BusinessLogicConsumer` использует нужную стратегию в зависимости от типа команды.

### Command
-   **Описание:** Инкапсулирует запрос как объект, позволяя параметризовать клиентов с разными запросами, ставить запросы в очередь и логировать их.
-   **Реализация:** `TransactionCommand` — это объект-команда, содержащий все данные для выполнения операции.

### Observer
-   **Описание:** Определяет зависимость "один ко многим" между объектами так, что при изменении состояния одного объекта все его зависимые объекты автоматически оповещаются.
-   **Реализация:** `BankServerFacade` (`api`) выступает как "субъект", который отслеживает обработанные транзакции. UI-компоненты подписываются как "наблюдатели" и асинхронно получают уведомления о завершении операций.

### State
-   **Описание:** Позволяет объекту изменять свое поведение при изменении его внутреннего состояния.
-   **Реализация:** Класс `Account` неявно реализует этот паттерн. Его поведение (возможность пополнения/снятия) зависит от `AccountStatus` (`ACTIVE`, `FROZEN`, `CLOSED`).

### Visitor
-   **Описание:** Позволяет добавлять новые операции к существующим классам, не изменяя их.
-   **Реализация:** `ReportVisitor` в `application` позволяет генерировать различные отчеты по объектам `Account` без модификации самого класса `Account`.

## Порождающие паттерны

### Factory (Simple Factory)
-   **Описание:** Инкапсулирует логику создания объектов.
-   **Реализация:** `TransactionActionFactory` в `core-engine` создает нужный объект-стратегию (`DepositAction` и т.д.) на основе типа команды.

### Singleton
-   **Описание:** Гарантирует, что у класса есть только один экземпляр, и предоставляет глобальную точку доступа к нему.
-   **Реализация:** `AccountState` в `core-engine` реализован как `enum` с одним элементом `INSTANCE`. Это потокобезопасный способ хранить единственное in-memory состояние счетов.

## Структурные паттерны

### Facade
-   **Описание:** Предоставляет унифицированный интерфейс к набору интерфейсов в подсистеме.
-   **Реализация:** `BankServerFacade` в `api` — это фасад, скрывающий всю сложность инициализации БД, запуска движка и координации сервисов.

### Adapter
-   **Описание:** Преобразует интерфейс одного класса в интерфейс другого, который ожидают клиенты.
-   **Реализация:** `DirectAdapter` в `ui` адаптирует `BankServerFacade` к интерфейсу `ServerConnection`, ожидаемому компонентами UI.

### Repository
-   **Описание:** Инкапсулирует логику доступа к источнику данных.
-   **Реализация:** `JdbcAccountRepository` и другие репозитории в `persistence` абстрагируют бизнес-логику от деталей работы с JDBC.
